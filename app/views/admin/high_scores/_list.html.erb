<%
   top = 10
   days_in_month = Time.days_in_month(Time.now.month-1, Time.now.year) #.months_ago(1).month)
   dt_utc = DateTime.now.utc #.months_ago(1) prev month
   dt1 = DateTime.new(dt_utc.year, dt_utc.month, 1).strftime("%Y-%m-%d")
   dt2 = DateTime.new(dt_utc.year, dt_utc.month, days_in_month).strftime("%Y-%m-%d")
   time_range = dt1..dt2
%>
<h2>Total High Scores/Current Month</h2>
<table class="index_table index">
  <thead>
  <tr>
    <th>#</th>
    <th>Player</th>
    <th>Score</th>
    <th>Logins/month</th>
  </tr>
  </thead>
  <tbody>
  <% no = 0
     ScoreHistory.joins(:user, :game).where('created_at' => time_range).
             select("games.title as gtitle, users.credits as credits, users.full_name as fname, users.id as uid, sum(amount) as sum_amount").
             group("users.full_name").order("sum_amount DESC, credits DESC").
             take(top).each do |score|
  %>
      <tr>
        <% no+=1
           no=no%=top %>
        <td><%= no == 0 ? top : no %></td>
        <td><%= score.try(:fname) %></td>
        <td><%= score.try(:sum_amount) %></td>
        <td><%= LoginHistory.where(created_at: time_range, user_id: score.uid).count %></td>
      </tr>
  <% end %>
  </tbody>
</table>
<br><br>


<h2>Every Day Logins/Current Month</h2>
<table class="index_table index">
  <thead>
  <tr>
    <th>#</th>
    <th>Player</th>
    <th>Logins/month</th>
  </tr>
  </thead>
  <tbody>
  <% gid = 0
     LoginHistory.
             joins(:user).
             where('created_at' => time_range).
             select("users.full_name as fname, users.id as uid, count(count) as login_count").
             group("fname").
             order("login_count DESC").
             #take(top).
             limit(top).
             each do |login|
       gid += 1
  %>

      <tr>
        <td><%= gid %></td>
        <td><%= login.try(:fname) %></td>
        <td>&nbsp<%= login.try(:login_count) %></td>
      </tr>
  <% end %>

  </table>
<br><br>

<h2>Top 10 Players For Each Game/Current Month</h2>

<% gid = 0
   Game.order(:title).each do |game| %>

    <h2><%= gid += 1 %>. <%= game.try(:title) %></h2>
    <table class="index_table index">
      <thead>
      <tr>
        <th>#</th>
        <th>Player</th>
        <th>Score</th>
      </tr>
      </thead>
      <tbody>
      <%
         no = 0
         sql="SELECT *, SUM(sc.amount) as sum, COUNT(u.id) as count_user FROM score_histories sc, users u, games g
       WHERE g.id = sc.game_id and u.id = sc.user_id AND g.id = #{game.try(:id)} AND sc.created_at >= '#{dt1}' AND sc.created_at <= '#{dt2}'
       GROUP BY g.title, u.full_name
       ORDER BY g.title, sum DESC limit #{top}";
         ScoreHistory.find_by_sql(sql).each do |score|
      %>
          <tr>
            <td><%= no+=1 %></td>
            <!--<td><%= score.try(:count_user) %></td>-->
            <!--<td><%= score.try(:game).try(:title) %>|</td>-->
            <td><%= score.try(:user).try(:full_name) %></td>
            <td><%= score.try(:sum) %></td>
          </tr>
      <% end %>
      </tbody>
    </table>
<% end %>

<br>
<br>

<br><br>

<% current_user=User.first
   if current_user
%>
    <h2>Pot for a Prize (Example) </h2>
    <table class="index_table index">
      <thead>
      <tr>
        <th>#</th>
        <th>Game</th>
        <th>Player</th>
        <th>Score</th>
      </tr>
      </thead>
      <tbody>
      <% gid = 0
         Game.order(:title).each do |game| %>
          <%
             gid += 1
             no = 0
             ScoreHistory.find_by_sql("SELECT *, SUM(sc.amount) as sum, COUNT(u.id) as count_user FROM score_histories sc, users u, games g
       WHERE g.id = sc.game_id and u.id = sc.user_id AND g.id = #{game.try(:id)} AND sc.created_at >= '#{dt1}' AND sc.created_at <= '#{dt2}'
       GROUP BY g.title, u.full_name ORDER BY g.title, sum DESC limit #{top}
                                      ").each do |score|
          %>
              <tr>
                <% if current_user.try(:full_name) == score.user.full_name+"" %>
                    <td><%= gid %></td>
                    <td><%= game.try(:title) %></td>
                    <td><%= "YOU (#{score.user.full_name})" %></td>
                    <td>&nbsp<%= score.try(:sum) %></td>
                <% else %>

                <% end %>
              </tr>
          <% end %>
      <% end %>
      <b>
      <tr>
        <td></td>
        <td></td>
        <td>Total Scores</td>
        <td><%= ScoreHistory.find_by_sql("SELECT SUM(sc.amount) as sum FROM score_histories sc, users u
       WHERE  sc.created_at >= '#{dt1}' AND sc.created_at <= '#{dt2}' AND u.id = sc.user_id AND u.id = #{current_user.try(:id) }
       GROUP BY u.full_name ORDER BY sum DESC
                                ").try(:first).try(:sum) %></td>
      </tr>
      </b>
    </table>

    <br><br>
<% end %>

